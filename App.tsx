import React, { useState, useMemo } from 'react';
import { TAILWIND_COLORS, SHADES, COLOR_NAMES, ALL_COLORS, TUNDRA_COLORS, NEWYORK_COLORS } from './constants';
import { TemplateType, ContrastLevel, ColorInfo, HSL, RGB } from './types';

type PaletteType = 'tailwind' | 'tundra' | 'newyork';

// --- Utility Functions ---

function hexToRgb(hex: string): RGB {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return { r, g, b };
}

function rgbToHsl({ r, g, b }: RGB): HSL {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h = 0, s, l = (max + min) / 2;
  if (max === min) {
    h = s = 0;
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h /= 6;
  }
  return { h: h * 360, s: s * 100, l: l * 100 };
}

function getLuminance({ r, g, b }: RGB): number {
  const a = [r, g, b].map(v => {
    v /= 255;
    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
  });
  return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
}

function getContrast(rgb1: RGB, rgb2: RGB): number {
  const l1 = getLuminance(rgb1) + 0.05;
  const l2 = getLuminance(rgb2) + 0.05;
  return l1 > l2 ? l1 / l2 : l2 / l1;
}

function getColorDistance(hsl1: HSL, hsl2: HSL): number {
  const hueDist = Math.min(Math.abs(hsl1.h - hsl2.h), 360 - Math.abs(hsl1.h - hsl2.h));
  const normalizedHueDist = (hueDist / 180) * 100;
  const satDist = Math.abs(hsl1.s - hsl2.s);
  const lightDist = Math.abs(hsl1.l - hsl2.l);
  return Math.sqrt(Math.pow(normalizedHueDist, 2) + Math.pow(satDist, 2) + Math.pow(lightDist, 2));
}

const CONTRAST_THRESHOLDS: Record<ContrastLevel, number> = {
  'A': 3.0,
  'AA': 4.5,
  'AAA': 7.0
};

type ViewMode = 'large' | 'mini';

interface ComboWithMeta {
  c1: ColorInfo;
  c2: ColorInfo;
  hsl1: HSL;
  hsl2: HSL;
}

const HeroPreview = ({ color1, color2, textColor, showCode, code, template }: { color1: string, color2: string, textColor: string, showCode?: boolean, code?: string, template: TemplateType }) => {
  // SVG template with placeholders #8F00FF and #F45516
  const svgTemplate = `<svg viewBox="0 0 844 1195" preserveAspectRatio="xMidYMin slice" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M842.63 0H0V1194.08H842.63V0Z" fill="#8F00FF"/>
<path d="M129.99 984.659H59.9697V549.129C59.9697 500.269 69.5497 452.859 88.4297 408.199C106.67 365.089 132.76 326.369 166 293.139C199.24 259.909 237.95 233.799 281.06 215.569C325.72 196.679 373.13 187.109 421.99 187.109C470.85 187.109 518.26 196.689 562.92 215.569C606.03 233.809 644.75 259.899 677.98 293.139C711.21 326.379 737.32 365.089 755.55 408.199C774.44 452.859 784.01 500.269 784.01 549.129V963.899H713.98V549.129C713.98 471.129 683.61 397.809 628.46 342.649C573.31 287.499 499.98 257.129 421.98 257.129C343.98 257.129 270.66 287.499 215.5 342.649C160.35 397.799 129.98 471.129 129.98 549.129V984.659H129.99Z" fill="#F45516"/>
<path d="M60.3403 62.6981V82.0181H92.5903V90.6381H60.3403V110.318H95.2403V118.938H50.0303V54.0781H95.2403V62.6981H60.3403Z" fill="black"/>
<path d="M102.8 95.36C102.8 80.39 112.82 70.5 127.86 70.5C140.06 70.5 148.19 76.58 149.8 86.83H139.78C138.55 81.57 134.39 78.58 127.86 78.58C118.4 78.58 112.63 85.02 112.63 95.36C112.63 105.7 118.4 112.14 127.86 112.14C134.39 112.14 138.55 109.24 139.78 103.98H149.8C148.29 114.14 139.87 120.31 127.86 120.31C112.82 120.31 102.8 110.24 102.8 95.36Z" fill="black"/>
<path d="M156.42 95.36C156.42 81.03 167.2 70.5 181.77 70.5C196.34 70.5 207.12 81.02 207.12 95.36C207.12 109.7 196.34 120.31 181.77 120.31C167.2 120.31 156.42 109.7 156.42 95.36ZM197.27 95.36C197.27 85.65 190.74 78.58 181.76 78.58C172.78 78.58 166.25 85.66 166.25 95.36C166.25 105.06 172.78 112.14 181.76 112.14C190.74 112.14 197.27 105.06 197.27 95.36Z" fill="black"/>
<path d="M217.89 52.7188H227.73V118.939H217.89V52.7188Z" fill="black"/>
<path d="M285.98 98.2578H248.62C249.57 107.148 254.77 112.138 263.37 112.138C270.08 112.138 274.44 109.148 275.38 103.978H285.41C283.99 114.138 275.67 120.308 263.37 120.308C248.33 120.308 238.59 110.508 238.59 95.1778C238.59 79.8478 247.95 70.5078 262.9 70.5078C277.85 70.5078 285.98 79.4878 285.98 94.0078V98.2678V98.2578ZM248.81 90.6378H275.95C275.76 83.3778 270.65 78.5778 262.9 78.5778C255.15 78.5778 250.23 83.0178 248.81 90.6378Z" fill="black"/>
<path d="M318.7 71.86H328.35V78.12H328.54C332.32 72.22 338.38 70.5 343.2 70.5C354.36 70.5 361.64 78.21 361.64 90.19V118.95H351.8V91.1C351.8 82.85 347.73 78.58 340.55 78.58C333.37 78.58 328.54 84.39 328.54 92.82V118.94H318.7V71.86Z" fill="black"/>
<path d="M371.66 95.36C371.66 81.03 382.44 70.5 397.01 70.5C411.58 70.5 422.36 81.02 422.36 95.36C422.36 109.7 411.58 120.31 397.01 120.31C382.44 120.31 371.66 109.7 371.66 95.36ZM412.51 95.36C412.51 85.65 405.98 78.58 397 78.58C388.02 78.58 381.49 85.66 381.49 95.36C381.49 105.06 388.02 112.14 397 112.14C405.98 112.14 412.51 105.06 412.51 95.36Z" fill="black"/>
<path d="M433.13 71.86H442.78V79.21H442.97C446.75 73.31 450.91 70.5 457.91 70.5H460.75V79.48H457.91C448.55 79.48 442.97 85.01 442.97 94.27V118.94H433.13V71.86Z" fill="black"/>
<path d="M469.44 71.86H479.09V78.12H479.28C482.21 73.04 486.85 70.5 493.09 70.5C499.33 70.5 504.16 73.22 507.37 79.39H507.56C510.59 73.49 515.69 70.5 522.5 70.5C533.66 70.5 540.56 77.76 540.56 89.55V118.94H530.72V90.46C530.72 82.84 527.22 78.67 520.79 78.67C513.79 78.67 509.91 83.66 509.91 92.73V118.95H500.08V90.47C500.08 82.85 496.58 78.68 490.24 78.68C483.24 78.68 479.27 83.76 479.27 92.74V118.96H469.43V71.88L469.44 71.86Z" fill="black"/>
<path d="M566.38 91.5478L575.93 90.9178C581.13 90.5578 583.31 89.1978 583.31 86.0178C583.31 81.4778 579.43 78.3978 573.29 78.3978C567.15 78.3978 563.55 81.3878 562.6 86.8378H552.58C553.9 76.7678 561.94 70.5078 573.39 70.5078C586.35 70.5078 593.16 77.3078 593.16 89.1978V118.948H583.51V112.688H583.32C580.01 118.498 574.05 120.308 568.66 120.308C558.45 120.308 551.64 114.318 551.64 105.608C551.64 97.4478 557.13 92.1778 566.39 91.5478H566.38ZM583.3 99.9778V96.3478C581.5 97.2578 579.61 97.7978 576.68 98.0678L568.64 98.6978C564.01 99.0578 561.45 101.418 561.45 105.408C561.45 109.858 564.76 112.118 570.34 112.118C577.43 112.118 583.3 106.678 583.3 99.9578V99.9778Z" fill="black"/>
<path d="M606.85 52.7188H616.69V118.939H606.85V52.7188Z" fill="black"/>
<path d="M674.94 98.2578H637.58C638.53 107.148 643.73 112.138 652.33 112.138C659.04 112.138 663.4 109.148 664.34 103.978H674.37C672.95 114.138 664.63 120.308 652.33 120.308C637.29 120.308 627.55 110.508 627.55 95.1778C627.55 79.8478 636.91 70.5078 651.86 70.5078C666.81 70.5078 674.94 79.4878 674.94 94.0078V98.2678V98.2578ZM637.77 90.6378H664.91C664.72 83.3778 659.61 78.5778 651.86 78.5778C644.11 78.5778 639.19 83.0178 637.77 90.6378Z" fill="black"/>
<path d="M326.53 180.72H336.18C337.22 186.34 340.62 188.88 347.15 188.88C353.68 188.88 357.18 186.52 357.18 182.62C357.18 179.72 355 177.81 349.99 176.81L341.76 175C332.4 173 327.57 168.47 327.57 161.76C327.57 153.05 335.51 147.25 346.58 147.25C358.21 147.25 365.21 153.33 365.87 163.58H356.7C356.04 158.23 352.54 155.33 346.58 155.33C341.09 155.33 337.31 157.87 337.31 161.59C337.31 164.49 339.67 166.4 344.88 167.58L353.39 169.3C362.75 171.3 367.01 175.29 367.01 182.09C367.01 191.25 359.16 197.06 346.87 197.06C334.58 197.06 327.39 191.16 326.54 180.73L326.53 180.72Z" fill="black"/>
<path d="M376.939 148.609H386.779V177.179C386.779 184.619 390.849 188.879 398.029 188.879C405.209 188.879 410.039 183.069 410.039 174.639V148.609H419.869V195.689H411.739C411.169 195.689 410.789 195.509 410.699 194.779L410.319 189.429H410.129C406.629 194.509 401.429 197.049 395.379 197.049C384.219 197.049 376.939 189.339 376.939 177.369V148.609Z" fill="black"/>
<path d="M434.25 148.61H443.9V154.87H444.09C447.59 149.97 454.11 147.25 461.21 147.25C475.21 147.25 484.85 157.41 484.85 172.2C484.85 186.99 475.11 197.06 461.11 197.06C454.11 197.06 448.06 194.43 444.28 189.44H444.09V213.84H434.25V148.62V148.61ZM475.01 172.2C475.01 162.04 468.86 155.33 459.31 155.33C449.76 155.33 443.7 161.95 443.7 172.2C443.7 182.45 449.85 188.89 459.31 188.89C468.77 188.89 475.01 182.27 475.01 172.2Z" fill="black"/>
<path d="M539.51 175.008H502.15C503.1 183.898 508.3 188.888 516.9 188.888C523.61 188.888 527.97 185.898 528.91 180.728H538.94C537.52 190.888 529.2 197.058 516.9 197.058C501.86 197.058 492.12 187.258 492.12 171.928C492.12 156.598 501.48 147.258 516.43 147.258C531.38 147.258 539.51 156.238 539.51 170.758V175.018V175.008ZM502.34 167.388H529.48C529.29 160.128 524.18 155.328 516.43 155.328C508.68 155.328 503.76 159.768 502.34 167.388Z" fill="black"/>
<path d="M550.57 148.61H560.22V155.96H560.41C564.19 150.06 568.35 147.25 575.35 147.25H578.19V156.23H575.35C565.99 156.23 560.41 161.76 560.41 171.02V195.69H550.57V148.61Z" fill="black"/>
<path d="M585.37 135.818C585.37 132.458 588.21 129.648 591.9 129.648C595.4 129.648 598.14 132.458 598.14 135.818C598.14 139.178 595.4 141.898 591.9 141.898C588.21 141.898 585.37 139.178 585.37 135.818ZM586.88 148.608H596.72V195.688H586.88V148.608Z" fill="black"/>
<path d="M654.97 175.008H617.61C618.56 183.898 623.76 188.888 632.36 188.888C639.07 188.888 643.43 185.898 644.37 180.728H654.4C652.98 190.888 644.66 197.058 632.36 197.058C617.32 197.058 607.58 187.258 607.58 171.928C607.58 156.598 616.94 147.258 631.89 147.258C646.84 147.258 654.97 156.238 654.97 170.758V175.018V175.008ZM617.8 167.388H644.94C644.75 160.128 639.64 155.328 631.89 155.328C624.14 155.328 619.22 159.768 617.8 167.388Z" fill="black"/>
<path d="M665.28 148.609H675.12V177.179C675.12 184.619 679.19 188.879 686.37 188.879C693.55 188.879 698.38 183.069 698.38 174.639V148.609H708.21V195.689H700.08C699.51 195.689 699.13 195.509 699.04 194.779L698.66 189.429H698.47C694.97 194.509 689.77 197.049 683.72 197.049C672.56 197.049 665.28 189.339 665.28 177.369V148.609Z" fill="black"/>
<path d="M722.59 148.61H732.24V155.96H732.43C736.21 150.06 740.37 147.25 747.37 147.25H750.21V156.23H747.37C738.01 156.23 732.43 161.76 732.43 171.02V195.69H722.59V148.61Z" fill="black"/>
<path d="M801.27 175.008H763.91C764.86 183.898 770.06 188.888 778.66 188.888C785.37 188.888 789.73 185.898 790.67 180.728H800.7C799.28 190.888 790.96 197.058 778.66 197.058C763.62 197.058 753.88 187.258 753.88 171.928C753.88 156.598 763.24 147.258 778.19 147.258C793.14 147.258 801.27 156.238 801.27 170.758V175.018V175.008ZM764.1 167.388H791.24C791.05 160.128 785.94 155.328 778.19 155.328C770.44 155.328 765.52 159.768 764.1 167.388Z" fill="black"/>
<path d="M160.099 257.197H149.789V272.437H140.329V257.197H108.649V249.127L138.059 212.117H149.789V249.127H160.099V257.197ZM140.339 249.127V223.187H140.149L119.909 248.947V249.127H140.339Z" fill="black"/>
<path d="M167.76 255.299H177.59C177.59 260.649 182.13 265.639 189.98 265.639C197.83 265.639 203.6 260.199 203.6 252.939C203.6 245.679 197.93 240.509 189.98 240.509C185.25 240.509 180.9 243.139 178.54 247.219H168.8L169.56 212.109H209.75V220.269H178.16L177.78 239.139H177.97C180.81 234.969 186.2 232.519 192.44 232.519C204.55 232.519 213.44 241.229 213.44 252.839C213.44 265.269 203.51 273.789 189.99 273.789C176.47 273.789 167.77 266.439 167.77 255.289L167.76 255.299Z" fill="black"/>
<path d="M235.28 266.19V275.08C235.28 281.43 229.98 284.24 222.7 284.24V279.43C226.86 279.43 229.98 278.43 229.98 275.08V272.72C229.51 272.81 228.94 272.9 228.47 272.9C224.59 272.9 221.57 269.91 221.57 266.19C221.57 262.47 224.6 259.75 228.47 259.75C232.34 259.75 235.28 262.74 235.28 266.19Z" fill="black"/>
<path d="M266.3 225.36H275.95V232.71H276.14C279.92 226.81 284.08 224 291.08 224H293.92V232.98H291.08C281.72 232.98 276.14 238.51 276.14 247.77V272.44H266.3V225.36Z" fill="black"/>
<path d="M301.859 225.359H311.699V253.929C311.699 261.369 315.769 265.629 322.949 265.629C330.129 265.629 334.959 259.819 334.959 251.389V225.359H344.789V272.439H336.659C336.089 272.439 335.709 272.259 335.619 271.529L335.239 266.179H335.049C331.549 271.259 326.349 273.799 320.299 273.799C309.139 273.799 301.859 266.089 301.859 254.119V225.359Z" fill="black"/>
<path d="M403.05 251.758H365.69C366.64 260.648 371.84 265.638 380.44 265.638C387.15 265.638 391.51 262.648 392.45 257.478H402.48C401.06 267.638 392.74 273.808 380.44 273.808C365.4 273.808 355.66 264.008 355.66 248.678C355.66 233.348 365.02 224.008 379.97 224.008C394.92 224.008 403.05 232.988 403.05 247.508V251.768V251.758ZM365.88 244.138H393.02C392.83 236.878 387.72 232.078 379.97 232.078C372.22 232.078 367.3 236.518 365.88 244.138Z" fill="black"/>
<path d="M455.91 223.999C462.91 223.999 468.96 226.539 472.74 231.349H472.93V206.219H482.76V272.439H474.53C473.96 272.439 473.58 272.169 473.49 271.439L473.11 266.179H472.92C469.61 271.079 463.08 273.799 455.99 273.799C441.9 273.799 432.16 263.639 432.16 248.849C432.16 234.059 442 223.989 455.9 223.989L455.91 223.999ZM473.31 248.859C473.31 238.699 467.16 232.079 457.71 232.079C448.26 232.079 442.01 238.699 442.01 248.859C442.01 259.019 448.16 265.639 457.71 265.639C467.26 265.639 473.31 259.019 473.31 248.859Z" fill="black"/>
<path d="M507.069 212.301V220.371C507.069 226.271 502.149 228.901 495.439 228.901V224.451C499.319 224.451 502.249 223.631 502.249 220.371V218.191C501.779 218.281 501.299 218.371 500.739 218.371C497.239 218.371 494.399 215.651 494.399 212.201C494.399 208.751 497.239 206.211 500.739 206.211C504.239 206.211 507.079 208.931 507.079 212.201V212.291L507.069 212.301Z" fill="black"/>
<path d="M519.08 247.948V207.578H529.39V247.858C529.39 259.738 534.12 265.188 544.52 265.188C554.92 265.188 559.65 259.748 559.65 247.858V207.578H569.96V247.948C569.96 264.728 561.26 273.798 544.52 273.798C527.78 273.798 519.08 264.728 519.08 247.948Z" fill="black"/>
<path d="M584.05 206.219H593.89V272.439H584.05V206.219Z" fill="black"/>
<path d="M608.26 225.36H617.91V231.62H618.1C621.03 226.54 625.67 224 631.91 224C638.15 224 642.98 226.72 646.19 232.89H646.38C649.41 226.99 654.51 224 661.32 224C672.48 224 679.38 231.26 679.38 243.05V272.44H669.54V243.96C669.54 236.34 666.04 232.17 659.61 232.17C652.61 232.17 648.73 237.16 648.73 246.23V272.45H638.9V243.97C638.9 236.35 635.4 232.18 629.06 232.18C622.06 232.18 618.09 237.26 618.09 246.24V272.46H608.25V225.38L608.26 225.36Z" fill="black"/>
<path d="M44.6399 288.867H90.7899L58.3499 349.187H47.4699L75.6499 297.207V297.027H44.6299V288.867H44.6399Z" fill="black"/>
<path d="M96.6494 332.049H106.479C106.479 337.399 111.019 342.389 118.869 342.389C126.719 342.389 132.489 336.949 132.489 329.689C132.489 322.429 126.819 317.259 118.869 317.259C114.139 317.259 109.789 319.889 107.429 323.969H97.6894L98.4494 288.859H138.639V297.019H107.049L106.669 315.889H106.859C109.699 311.719 115.089 309.269 121.329 309.269C133.439 309.269 142.329 317.979 142.329 329.589C142.329 342.019 132.399 350.539 118.879 350.539C105.359 350.539 96.6594 343.189 96.6594 332.039L96.6494 332.049Z" fill="black"/>
<path d="M150.84 318.988C150.84 299.668 159.64 287.508 174.77 287.508C189.9 287.508 198.79 299.578 198.79 318.988C198.79 338.398 189.9 350.558 174.77 350.558C159.64 350.558 150.84 338.498 150.84 318.988ZM188.95 318.988C188.95 304.658 183.94 295.678 174.76 295.678C165.58 295.678 160.67 304.748 160.67 318.988C160.67 333.228 165.49 342.388 174.76 342.388C184.03 342.388 188.95 333.948 188.95 318.988Z" fill="black"/>
<path d="M208.05 318.988C208.05 299.668 216.85 287.508 231.98 287.508C247.11 287.508 256 299.578 256 318.988C256 338.398 247.11 350.558 231.98 350.558C216.85 350.558 208.05 338.498 208.05 318.988ZM246.17 318.988C246.17 304.658 241.16 295.678 231.98 295.678C222.8 295.678 217.89 304.748 217.89 318.988C217.89 333.228 222.71 342.388 231.98 342.388C241.25 342.388 246.17 333.948 246.17 318.988Z" fill="black"/>
<path d="M265.649 332.049H275.479C275.479 337.399 280.019 342.389 287.869 342.389C295.719 342.389 301.489 336.949 301.489 329.689C301.489 322.429 295.819 317.259 287.869 317.259C283.139 317.259 278.789 319.889 276.429 323.969H266.689L267.449 288.859H307.639V297.019H276.049L275.669 315.889H275.859C278.699 311.719 284.089 309.269 290.329 309.269C302.439 309.269 311.329 317.979 311.329 329.589C311.329 342.019 301.399 350.539 287.879 350.539C274.359 350.539 265.659 343.189 265.659 332.039L265.649 332.049Z" fill="black"/>
<path d="M652.99 303.476C652.99 314.996 644.76 322.706 632.09 322.706H615.35V349.196H605.04V284.336H632.09C644.76 284.336 652.99 291.866 652.99 303.476ZM642.68 303.476C642.68 296.946 638.14 292.956 630.67 292.956H615.35V314.096H630.67C638.14 314.096 642.68 310.106 642.68 303.486V303.476Z" fill="black"/>
<path d="M673.32 321.798L682.87 321.168C688.07 320.808 690.25 319.448 690.25 316.268C690.25 311.728 686.37 308.648 680.23 308.648C674.09 308.648 670.49 311.638 669.54 317.088H659.52C660.84 307.018 668.88 300.758 680.33 300.758C693.29 300.758 700.1 307.558 700.1 319.448V349.198H690.45V342.938H690.26C686.95 348.748 680.99 350.558 675.6 350.558C665.39 350.558 658.58 344.568 658.58 335.858C658.58 327.698 664.07 322.428 673.33 321.798H673.32ZM690.25 330.238V326.608C688.45 327.518 686.56 328.058 683.63 328.328L675.59 328.958C670.96 329.318 668.4 331.678 668.4 335.668C668.4 340.118 671.71 342.378 677.29 342.378C684.38 342.378 690.25 336.938 690.25 330.218V330.238Z" fill="black"/>
<path d="M713.8 302.118H723.45V309.468H723.64C727.42 303.568 731.58 300.758 738.58 300.758H741.42V309.738H738.58C729.22 309.738 723.64 315.268 723.64 324.528V349.198H713.8V302.118Z" fill="black"/>
<path d="M748.6 289.318C748.6 285.958 751.44 283.148 755.13 283.148C758.63 283.148 761.37 285.958 761.37 289.318C761.37 292.678 758.63 295.398 755.13 295.398C751.44 295.398 748.6 292.678 748.6 289.318ZM750.11 302.118H759.95V349.198H750.11V302.118Z" fill="black"/>
<path d="M770.439 334.228H780.089C781.129 339.848 784.529 342.388 791.059 342.388C797.589 342.388 801.089 340.028 801.089 336.128C801.089 333.228 798.909 331.318 793.899 330.318L785.669 328.508C776.309 326.508 771.479 321.978 771.479 315.268C771.479 306.558 779.419 300.758 790.489 300.758C802.119 300.758 809.119 306.838 809.779 317.088H800.609C799.949 311.738 796.449 308.838 790.489 308.838C784.999 308.838 781.219 311.378 781.219 315.098C781.219 317.998 783.579 319.908 788.789 321.088L797.299 322.808C806.659 324.808 810.919 328.798 810.919 335.598C810.919 344.758 803.069 350.568 790.779 350.568C778.489 350.568 771.299 344.668 770.449 334.238L770.439 334.228Z" fill="black"/>
<path d="M87.2301 39C84.2501 42.88 80.8101 46.49 77.5501 50.19H67.8701L74.9501 39H87.2301Z" fill="black"/>
<path d="M463.86 131.18C460.88 135.06 457.44 138.67 454.18 142.37H444.5L451.58 131.18H463.86Z" fill="black"/>
<path d="M843.99 963.898H0V1194.08H843.99V963.898Z" fill="#EAEAEA"/>
<path d="M48.7201 1083H44.3701V1041.84C44.3701 1020.11 62.0501 1002.44 83.7701 1002.44C105.49 1002.44 123.17 1020.12 123.17 1041.84V1051.23H118.82V1041.84C118.82 1022.51 103.1 1006.79 83.7701 1006.79C64.4401 1006.79 48.7201 1022.51 48.7201 1041.84V1083Z" fill="black"/>
<path d="M118.811 1059.3H123.181V1078.81H118.811V1059.3Z" fill="black"/>
<path d="M126.801 1064.21H130.981V1065.98H131.041C132.001 1064.59 133.441 1063.8 135.241 1063.8C138.791 1063.8 140.701 1066.17 140.701 1070.43V1078.81H136.471V1070.7C136.471 1068.38 135.571 1067.21 133.771 1067.21C131.971 1067.21 131.041 1068.44 131.041 1070.7V1078.81H126.811V1064.21H126.801Z" fill="black"/>
<path d="M143.2 1073.76H147.43C147.68 1075.21 148.44 1075.81 149.94 1075.81C151.28 1075.81 152.12 1075.32 152.12 1074.5C152.12 1073.87 151.68 1073.57 150.24 1073.27L147.54 1072.7C144.73 1072.1 143.26 1070.68 143.26 1068.55C143.26 1065.6 145.88 1063.8 149.51 1063.8C153.44 1063.8 155.35 1065.6 155.81 1069.26H151.85C151.69 1067.81 150.98 1067.21 149.5 1067.21C148.3 1067.21 147.48 1067.7 147.48 1068.49C147.48 1069.17 147.97 1069.53 149.28 1069.8L152.34 1070.43C154.96 1070.98 156.35 1072.31 156.35 1074.36C156.35 1077.33 153.73 1079.22 149.72 1079.22C145.71 1079.22 143.39 1077.34 143.2 1073.76Z" fill="black"/>
<path d="M164.031 1067.62V1074.31C164.031 1075.1 164.331 1075.4 165.091 1075.4H167.741V1078.81H163.761C161.441 1078.81 159.801 1077.31 159.801 1075.13V1067.63H157.211V1064.22H159.801V1059.99H164.031V1064.22H167.741V1067.63H164.031V1067.62Z" fill="black"/>
<path d="M170.08 1060.58C170.08 1059.3 171.14 1058.21 172.51 1058.21C173.88 1058.21 174.86 1059.3 174.86 1060.58C174.86 1061.86 173.85 1062.98 172.51 1062.98C171.17 1062.98 170.08 1061.89 170.08 1060.58ZM170.41 1064.21H174.64V1078.81H170.41V1064.21Z" fill="black"/>
<path d="M183.871 1067.62V1074.31C183.871 1075.1 184.171 1075.4 184.931 1075.4H187.581V1078.81H183.601C181.281 1078.81 179.641 1077.31 179.641 1075.13V1067.63H177.051V1064.22H179.641V1059.99H183.871V1064.22H187.581V1067.63H183.871V1067.62Z" fill="black"/>
<path d="M190.141 1064.21H194.371V1072.32C194.371 1074.64 195.271 1075.81 197.071 1075.81C198.871 1075.81 199.801 1074.58 199.801 1072.32V1064.21H204.031V1078.81H200.401C200.241 1078.81 200.101 1078.7 200.101 1078.54L199.991 1077.04H199.931C198.981 1078.43 197.581 1079.22 195.591 1079.22C192.041 1079.22 190.131 1076.85 190.131 1072.59V1064.21H190.141Z" fill="black"/>
<path d="M213.18 1067.62V1074.31C213.18 1075.1 213.48 1075.4 214.24 1075.4H216.89V1078.81H212.91C210.59 1078.81 208.95 1077.31 208.95 1075.13V1067.63H206.36V1064.22H208.95V1059.99H213.18V1064.22H216.89V1067.63H213.18V1067.62Z" fill="black"/>
<path d="M39.2704 1118.11C41.2404 1118.11 42.9304 1118.87 44.0204 1120.29H44.0804V1113.19H48.3104V1133.11H44.5404C44.3804 1133.11 44.2704 1133.03 44.2404 1132.84L44.1304 1131.34H44.0804C43.2904 1132.65 41.5404 1133.52 39.3904 1133.52C35.1604 1133.52 32.4004 1130.46 32.4004 1125.8C32.4004 1121.14 35.1604 1118.1 39.2804 1118.1L39.2704 1118.11ZM44.1904 1125.8C44.1904 1123.32 42.6104 1121.52 40.4004 1121.52C38.1904 1121.52 36.6304 1123.32 36.6304 1125.8C36.6304 1128.28 38.2104 1130.11 40.4004 1130.11C42.5904 1130.11 44.1904 1128.31 44.1904 1125.8Z" fill="black"/>
<path d="M51.0605 1115.31V1113.59H54.6105V1115.31L53.9505 1120H51.7105L51.0605 1115.31Z" fill="black"/>
<path d="M71.4207 1126.88H60.7507C61.0207 1129.09 62.1407 1130.1 64.2707 1130.1C65.9607 1130.1 66.8907 1129.42 67.0507 1128.05H71.2807C70.8707 1131.57 68.3607 1133.51 64.2707 1133.51C59.4407 1133.51 56.4707 1130.56 56.4707 1125.76C56.4707 1120.96 59.4207 1118.09 64.2507 1118.09C68.8107 1118.09 71.4307 1120.87 71.4307 1125.76V1126.88H71.4207ZM60.8607 1124.15H67.1407C67.0607 1122.51 65.9907 1121.5 64.2507 1121.5C62.5107 1121.5 61.3007 1122.43 60.8707 1124.15H60.8607Z" fill="black"/>
<path d="M79.5007 1121.93V1128.62C79.5007 1129.41 79.8007 1129.71 80.5607 1129.71H83.2107V1133.12H79.2307C76.9107 1133.12 75.2707 1131.62 75.2707 1129.44V1121.94H72.6807V1118.53H75.2707V1114.3H79.5007V1118.53H83.2107V1121.94H79.5007V1121.93Z" fill="black"/>
<path d="M85.5305 1118.51H89.7605V1126.62C89.7605 1128.94 90.6605 1130.11 92.4605 1130.11C94.2605 1130.11 95.1905 1128.88 95.1905 1126.62V1118.51H99.4205V1133.11H95.7905C95.6305 1133.11 95.4905 1133 95.4905 1132.84L95.3805 1131.34H95.3205C94.3705 1132.73 92.9705 1133.52 90.9805 1133.52C87.4305 1133.52 85.5205 1131.15 85.5205 1126.89V1118.51H85.5305Z" fill="black"/>
<path d="M108.921 1118.11C110.891 1118.11 112.581 1118.87 113.671 1120.29H113.731V1113.19H117.961V1133.11H114.191C114.031 1133.11 113.921 1133.03 113.891 1132.84L113.781 1131.34H113.731C112.941 1132.65 111.191 1133.52 109.041 1133.52C104.811 1133.52 102.051 1130.46 102.051 1125.8C102.051 1121.14 104.811 1118.1 108.931 1118.1L108.921 1118.11ZM113.831 1125.8C113.831 1123.32 112.251 1121.52 110.041 1121.52C107.831 1121.52 106.271 1123.32 106.271 1125.8C106.271 1128.28 107.851 1130.11 110.041 1130.11C112.231 1130.11 113.831 1128.31 113.831 1125.8Z" fill="black"/>
<path d="M135.501 1126.88H124.831C125.101 1129.09 126.221 1130.1 128.351 1130.1C130.041 1130.1 130.971 1129.42 131.131 1128.05H135.361C134.951 1131.57 132.441 1133.51 128.351 1133.51C123.521 1133.51 120.551 1130.56 120.551 1125.76C120.551 1120.96 123.501 1118.09 128.331 1118.09C132.891 1118.09 135.511 1120.87 135.511 1125.76V1126.88H135.501ZM124.941 1124.15H131.221C131.141 1122.51 130.071 1121.5 128.331 1121.5C126.591 1121.5 125.381 1122.43 124.951 1124.15H124.941Z" fill="black"/>
<path d="M137.33 1128.07H141.56C141.81 1129.52 142.57 1130.12 144.07 1130.12C145.41 1130.12 146.25 1129.63 146.25 1128.81C146.25 1128.18 145.81 1127.88 144.37 1127.58L141.67 1127.01C138.86 1126.41 137.39 1124.99 137.39 1122.86C137.39 1119.91 140.01 1118.11 143.64 1118.11C147.57 1118.11 149.48 1119.91 149.94 1123.57H145.98C145.82 1122.12 145.11 1121.52 143.63 1121.52C142.43 1121.52 141.61 1122.01 141.61 1122.8C141.61 1123.48 142.1 1123.84 143.41 1124.11L146.47 1124.74C149.09 1125.29 150.48 1126.62 150.48 1128.67C150.48 1131.64 147.86 1133.53 143.85 1133.53C139.84 1133.53 137.52 1131.65 137.33 1128.07Z" fill="black"/>
<path d="M68.9007 1112.3C67.8707 1113.68 66.6807 1114.97 65.5607 1116.29H62.2207L64.6607 1112.3H68.9007Z" fill="black"/>
<path d="M39.8202 1090.8C41.8702 1090.8 43.6102 1091.65 44.4302 1093.01H44.4802V1091.21H48.6602V1103.63C48.6602 1108.84 45.9902 1111.68 41.0702 1111.68C36.8902 1111.68 34.0602 1109.91 33.4802 1106.22H37.7102C38.0602 1107.67 39.2402 1108.27 41.0702 1108.27C43.2802 1108.27 44.4302 1106.99 44.4302 1104.48V1103.09H44.3702C43.5502 1104.62 42.0002 1105.41 39.8102 1105.41C35.6602 1105.41 32.9902 1102.54 32.9902 1098.1C32.9902 1093.9 35.8602 1090.81 39.8102 1090.81L39.8202 1090.8ZM44.5702 1098.08C44.5702 1095.84 43.0402 1094.2 40.9102 1094.2C38.7802 1094.2 37.2302 1095.81 37.2302 1098.08C37.2302 1100.35 38.7602 1101.98 40.9102 1101.98C43.0602 1101.98 44.5702 1100.34 44.5702 1098.08Z" fill="black"/>
<path d="M65.45 1099.58H54.78C55.05 1101.79 56.17 1102.8 58.3 1102.8C59.99 1102.8 60.92 1102.12 61.08 1100.75H65.31C64.9 1104.27 62.39 1106.21 58.3 1106.21C53.47 1106.21 50.5 1103.26 50.5 1098.46C50.5 1093.66 53.45 1090.79 58.28 1090.79C62.84 1090.79 65.46 1093.57 65.46 1098.46V1099.58H65.45ZM54.89 1096.85H61.17C61.09 1095.21 60.02 1094.2 58.28 1094.2C56.54 1094.2 55.33 1095.13 54.9 1096.85H54.89Z" fill="black"/>
<path d="M67.1699 1098.46C67.1699 1093.96 70.4699 1090.79 75.1899 1090.79C79.9099 1090.79 83.1899 1093.96 83.1899 1098.46C83.1899 1102.96 79.8899 1106.21 75.1899 1106.21C70.4899 1106.21 67.1699 1103.02 67.1699 1098.46ZM78.9599 1098.46C78.9599 1095.98 77.3799 1094.2 75.1899 1094.2C72.9999 1094.2 71.3999 1095.97 71.3999 1098.46C71.3999 1100.95 72.9799 1102.8 75.1899 1102.8C77.3999 1102.8 78.9599 1100.97 78.9599 1098.46Z" fill="black"/>
<path d="M85.4004 1091.21H89.5804V1092.98H89.6404C90.6804 1091.62 92.4804 1090.8 94.5204 1090.8C98.5904 1090.8 101.32 1093.88 101.32 1098.52C101.32 1103.16 98.5604 1106.22 94.4404 1106.22C92.4804 1106.22 90.7804 1105.46 89.6904 1104.04H89.6404V1111.27H85.4104V1091.21H85.4004ZM97.0804 1098.52C97.0804 1096.04 95.5004 1094.21 93.3104 1094.21C91.1204 1094.21 89.5204 1096.01 89.5204 1098.52C89.5204 1101.03 91.1004 1102.8 93.3104 1102.8C95.5204 1102.8 97.0804 1101 97.0804 1098.52Z" fill="black"/>
<path d="M102.86 1098.46C102.86 1093.96 106.16 1090.79 110.88 1090.79C115.6 1090.79 118.88 1093.96 118.88 1098.46C118.88 1102.96 115.58 1106.21 110.88 1106.21C106.18 1106.21 102.86 1103.02 102.86 1098.46ZM114.65 1098.46C114.65 1095.98 113.07 1094.2 110.88 1094.2C108.69 1094.2 107.09 1095.97 107.09 1098.46C107.09 1100.95 108.67 1102.8 110.88 1102.8C113.09 1102.8 114.65 1100.97 114.65 1098.46Z" fill="black"/>
<path d="M121.23 1085.88H125.46V1105.8H121.23V1085.88Z" fill="black"/>
<path d="M128.63 1087.58C128.63 1086.3 129.69 1085.21 131.06 1085.21C132.43 1085.21 133.41 1086.3 133.41 1087.58C133.41 1088.86 132.4 1089.98 131.06 1089.98C129.72 1089.98 128.63 1088.89 128.63 1087.58ZM128.95 1091.21H133.18V1105.81H128.95V1091.21Z" fill="black"/>
<path d="M142.11 1094.62V1101.31C142.11 1102.1 142.41 1102.4 143.17 1102.4H145.82V1105.81H141.84C139.52 1105.81 137.88 1104.31 137.88 1102.13V1094.63H135.29V1091.22H137.88V1086.99H142.11V1091.22H145.82V1094.63H142.11V1094.62Z" fill="black"/>
<path d="M147.98 1087.58C147.98 1086.3 149.04 1085.21 150.41 1085.21C151.78 1085.21 152.76 1086.3 152.76 1087.58C152.76 1088.86 151.75 1089.98 150.41 1089.98C149.07 1089.98 147.98 1088.89 147.98 1087.58ZM148.3 1091.21H152.53V1105.81H148.3V1091.21Z" fill="black"/>
<path d="M162.06 1090.8C164.19 1090.8 165.85 1091.67 166.73 1092.98H166.78L166.89 1091.48C166.92 1091.29 167.03 1091.21 167.19 1091.21H170.96V1111.27H166.73V1104.04H166.67C165.58 1105.46 163.89 1106.22 161.92 1106.22C157.8 1106.22 155.04 1103.11 155.04 1098.52C155.04 1093.93 157.8 1090.8 162.05 1090.8H162.06ZM166.83 1098.52C166.83 1096.01 165.25 1094.21 163.04 1094.21C160.83 1094.21 159.27 1096.04 159.27 1098.52C159.27 1101 160.85 1102.8 163.04 1102.8C165.23 1102.8 166.83 1101 166.83 1098.52Z" fill="black"/>
<path d="M173.77 1091.21H178V1099.32C178 1101.64 178.9 1102.81 180.7 1102.81C182.5 1102.81 183.43 1101.58 183.43 1099.32V1091.21H187.66V1105.81H184.03C183.87 1105.81 183.73 1105.7 183.73 1105.54L183.62 1104.04H183.56C182.61 1105.43 181.21 1106.22 179.22 1106.22C175.67 1106.22 173.76 1103.85 173.76 1099.59V1091.21H173.77Z" fill="black"/>
<path d="M204.99 1099.58H194.32C194.59 1101.79 195.71 1102.8 197.84 1102.8C199.53 1102.8 200.46 1102.12 200.62 1100.75H204.85C204.44 1104.27 201.93 1106.21 197.84 1106.21C193.01 1106.21 190.04 1103.26 190.04 1098.46C190.04 1093.66 192.99 1090.79 197.82 1090.79C202.38 1090.79 205 1093.57 205 1098.46V1099.58H204.99ZM194.43 1096.85H200.71C200.63 1095.21 199.56 1094.2 197.82 1094.2C196.08 1094.2 194.87 1095.13 194.44 1096.85H194.43Z" fill="black"/>
<path d="M63.0101 1085.09C61.9801 1086.47 60.7901 1087.76 59.6701 1089.08H56.3301L58.7701 1085.09H63.0101Z" fill="black"/>
<path d="M95.4406 1146.66L98.5006 1146.47C99.7006 1146.39 100.361 1145.95 100.361 1145.05C100.361 1144.15 99.6006 1143.33 98.2006 1143.33C96.6706 1143.33 95.9106 1144.23 95.6906 1145.65H91.4606C91.8406 1142.16 94.3006 1140.19 98.2806 1140.19C102.261 1140.19 104.581 1142.78 104.581 1146.03V1155.2H100.401V1153.43H100.341C99.5506 1154.88 98.1806 1155.61 96.2706 1155.61C93.2106 1155.61 91.1406 1153.73 91.1406 1150.97C91.1406 1148.51 92.8006 1146.82 95.4206 1146.66H95.4406ZM100.351 1149.2V1148.87C99.6106 1149.09 99.3406 1149.14 98.5506 1149.2L97.2406 1149.28C96.0706 1149.36 95.3806 1149.88 95.3806 1150.73C95.3806 1151.66 96.0606 1152.2 97.2106 1152.2C98.9606 1152.2 100.351 1150.89 100.351 1149.2Z" fill="black"/>
<path d="M110.591 1140.59L114.001 1150.09H114.051L117.431 1140.59H121.741L116.421 1155.19H111.621L106.271 1140.59H110.581H110.591Z" fill="black"/>
<path d="M127.21 1146.66L130.27 1146.47C131.47 1146.39 132.13 1145.95 132.13 1145.05C132.13 1144.15 131.37 1143.33 129.97 1143.33C128.44 1143.33 127.68 1144.23 127.46 1145.65H123.23C123.61 1142.16 126.07 1140.19 130.05 1140.19C134.03 1140.19 136.35 1142.78 136.35 1146.03V1155.2H132.17V1153.43H132.11C131.32 1154.88 129.95 1155.61 128.04 1155.61C124.98 1155.61 122.91 1153.73 122.91 1150.97C122.91 1148.51 124.57 1146.82 127.19 1146.66H127.21ZM132.12 1149.2V1148.87C131.38 1149.09 131.11 1149.14 130.32 1149.2L129.01 1149.28C127.84 1149.36 127.15 1149.88 127.15 1150.73C127.15 1151.66 127.83 1152.2 128.98 1152.2C130.73 1152.2 132.12 1150.89 132.12 1149.2Z" fill="black"/>
<path d="M139.681 1140.6H143.861V1142.37H143.921C144.881 1140.98 146.321 1140.19 148.121 1140.19C151.671 1140.19 153.581 1142.56 153.581 1146.82V1155.2H149.351V1147.09C149.351 1144.77 148.451 1143.6 146.651 1143.6C144.851 1143.6 143.921 1144.83 143.921 1147.09V1155.2H139.691V1140.6H139.681Z" fill="black"/>
<path d="M156.001 1147.86C156.001 1143.11 159.111 1140.19 164.081 1140.19C168.171 1140.19 170.681 1142.1 171.231 1145.65H167.001C166.591 1144.26 165.691 1143.6 164.081 1143.6C161.651 1143.6 160.231 1145.18 160.231 1147.88C160.231 1150.58 161.651 1152.19 164.081 1152.19C165.691 1152.19 166.591 1151.54 167.001 1150.14H171.231C170.681 1153.69 168.171 1155.6 164.081 1155.6C159.111 1155.6 156.001 1152.63 156.001 1147.85V1147.86Z" fill="black"/>
<path d="M187.711 1148.98H177.041C177.311 1151.19 178.431 1152.2 180.561 1152.2C182.251 1152.2 183.181 1151.52 183.341 1150.15H187.571C187.161 1153.67 184.651 1155.61 180.561 1155.61C175.731 1155.61 172.761 1152.66 172.761 1147.86C172.761 1143.06 175.711 1140.19 180.541 1140.19C185.101 1140.19 187.721 1142.97 187.721 1147.86V1148.98H187.711ZM177.151 1146.25H183.431C183.351 1144.61 182.281 1143.6 180.541 1143.6C178.801 1143.6 177.591 1144.53 177.161 1146.25H177.151Z" fill="black"/>
<path d="M204.411 1148.98H193.741C194.011 1151.19 195.131 1152.2 197.261 1152.2C198.951 1152.2 199.881 1151.52 200.041 1150.15H204.271C203.861 1153.67 201.351 1155.61 197.261 1155.61C192.431 1155.61 189.461 1152.66 189.461 1147.86C189.461 1143.06 192.411 1140.19 197.241 1140.19C201.801 1140.19 204.421 1142.97 204.421 1147.86V1148.98H204.411ZM193.851 1146.25H200.131C200.051 1144.61 198.981 1143.6 197.241 1143.6C195.501 1143.6 194.291 1144.53 193.861 1146.25H193.851Z" fill="black"/>
<path d="M206.24 1150.15H210.47C210.72 1151.6 211.48 1152.2 212.98 1152.2C214.32 1152.2 215.16 1151.71 215.16 1150.89C215.16 1150.26 214.72 1149.96 213.28 1149.66L210.58 1149.09C207.77 1148.49 206.3 1147.07 206.3 1144.94C206.3 1141.99 208.92 1140.19 212.55 1140.19C216.48 1140.19 218.39 1141.99 218.85 1145.65H214.89C214.73 1144.2 214.02 1143.6 212.54 1143.6C211.34 1143.6 210.52 1144.09 210.52 1144.88C210.52 1145.56 211.01 1145.92 212.32 1146.19L215.38 1146.82C218 1147.37 219.39 1148.7 219.39 1150.75C219.39 1153.72 216.77 1155.61 212.76 1155.61C208.75 1155.61 206.43 1153.73 206.24 1150.15Z" fill="black"/>
<path d="M184.16 1134.43C183.13 1135.81 181.94 1137.1 180.82 1138.42H177.48L179.92 1134.43H184.16Z" fill="black"/>
</svg>`;

  // Replace placeholder colors with actual combination colors
  let svgContent = svgTemplate
    .replace(/#8F00FF/g, color1)
    .replace(/#F45516/g, color2);

  // Adjust colors based on template
  if (template === TemplateType.DARK) {
    // Replace black with white
    svgContent = svgContent.replace(/fill="black"/g, 'fill="white"');
    // Replace #EAEAEA with black
    svgContent = svgContent.replace(/fill="#EAEAEA"/g, 'fill="black"');
  }

  return (
    <div className="relative w-full h-full overflow-hidden">
      {/* Background SVG */}
      <div 
        className="absolute inset-0"
        dangerouslySetInnerHTML={{ 
          __html: svgContent.replace(
            '<svg viewBox="0 0 844 1195" preserveAspectRatio="xMidYMin slice"',
            '<svg width="100%" height="100%" viewBox="0 0 844 1195" preserveAspectRatio="xMidYMin slice" style="display: block; width: 100%; height: 100%; object-fit: cover;"'
          )
        }}
      />
      
      {/* Code Overlay - Centered and clean for Mini View */}
      {showCode && code && (
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none select-none">
          <span className="text-[11px] font-mono font-black tracking-tight" style={{ color: textColor }}>
            {code}
          </span>
        </div>
      )}
    </div>
  );
};

export default function App() {
  const [paletteType, setPaletteType] = useState<PaletteType>('tundra');
  const [selectedIds, setSelectedIds] = useState<Set<string>>(
    new Set(TUNDRA_COLORS.map(c => c.id))
  );
  const [template, setTemplate] = useState<TemplateType>(TemplateType.LIGHT);
  const [minHueDistance, setMinHueDistance] = useState(0);
  const [minSatDistance, setMinSatDistance] = useState(0);
  const [minLumDistance, setMinLumDistance] = useState(0);
  const [minTotalDistance, setMinTotalDistance] = useState(0);
  const [minBgContrast, setMinBgContrast] = useState(1.4);
  const [contrastLevel, setContrastLevel] = useState<ContrastLevel>('A');
  const [viewMode, setViewMode] = useState<ViewMode>('large');
  const [isDiverse, setIsDiverse] = useState(true);

  const currentPalette = paletteType === 'tundra' ? TUNDRA_COLORS : 
                         paletteType === 'newyork' ? NEWYORK_COLORS : 
                         ALL_COLORS;

  const textColorHex = template === TemplateType.DARK ? '#FFFFFF' : '#000000';
  const textColorRgb = hexToRgb(textColorHex);
  const threshold = CONTRAST_THRESHOLDS[contrastLevel];

  const checkContrast = (hex: string) => {
    return getContrast(hexToRgb(hex), textColorRgb) >= threshold;
  };

  const toggleId = (id: string) => {
    const next = new Set(selectedIds);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    setSelectedIds(next);
  };

  const toggleColorGroup = (name: string) => {
    const next = new Set(selectedIds);
    if (paletteType === 'tundra') {
      const color = TUNDRA_COLORS.find(c => c.name === name);
      if (color) {
        if (next.has(color.id)) next.delete(color.id);
        else next.add(color.id);
      }
    } else if (paletteType === 'newyork') {
      const color = NEWYORK_COLORS.find(c => c.name === name);
      if (color) {
        if (next.has(color.id)) next.delete(color.id);
        else next.add(color.id);
      }
    } else {
      const groupIds = SHADES.map(s => `${name}-${s}`).filter(id => {
        const color = ALL_COLORS.find(c => c.id === id);
        return color && checkContrast(color.hex);
      });
      const allSelected = groupIds.length > 0 && groupIds.every(id => next.has(id));
      if (allSelected) groupIds.forEach(id => next.delete(id));
      else groupIds.forEach(id => next.add(id));
    }
    setSelectedIds(next);
  };

  const toggleShadeGroup = (shade: string) => {
    if (paletteType === 'tundra') return; // No shades for tundra
    const next = new Set(selectedIds);
    const shadeIds = COLOR_NAMES.map(name => `${name}-${shade}`).filter(id => {
      const color = ALL_COLORS.find(c => c.id === id);
      return color && checkContrast(color.hex);
    });
    
    if (shadeIds.length === 0) return;

    const allSelected = shadeIds.every(id => next.has(id));
    if (allSelected) {
      shadeIds.forEach(id => next.delete(id));
    } else {
      shadeIds.forEach(id => next.add(id));
    }
    setSelectedIds(next);
  };

  const selectAll = () => {
    const next = new Set<string>();
    currentPalette.forEach(c => { if (checkContrast(c.hex)) next.add(c.id); });
    setSelectedIds(next);
  };
  
  const deselectAll = () => setSelectedIds(new Set());

  // Reset selected colors when switching palettes
  React.useEffect(() => {
    if (paletteType === 'tundra') {
      setSelectedIds(new Set(TUNDRA_COLORS.map(c => c.id)));
    } else if (paletteType === 'newyork') {
      setSelectedIds(new Set(NEWYORK_COLORS.map(c => c.id)));
    } else {
      setSelectedIds(new Set(ALL_COLORS.filter(c => ['400', '500', '600', '700'].includes(c.shade)).map(c => c.id)));
    }
  }, [paletteType]);

  const getComboCode = (c1: ColorInfo, c2: ColorInfo) => {
    if (paletteType === 'tundra' || paletteType === 'newyork') {
      const n1 = c1.name.substring(0, 3).toUpperCase();
      const n2 = c2.name.substring(0, 3).toUpperCase();
      return `${n1}-${n2}`;
    }
    const n1 = c1.name.substring(0, 2).toUpperCase();
    const n2 = c2.name.substring(0, 2).toUpperCase();
    return `${n1}${c1.shade}-${n2}${c2.shade}`;
  };

  const baseCombinations = useMemo(() => {
    const activeColors = currentPalette.filter(c => selectedIds.has(c.id));
    const candidates: ComboWithMeta[] = [];

    for (let i = 0; i < activeColors.length; i++) {
      const c1 = activeColors[i];
      const rgb1 = hexToRgb(c1.hex);
      if (getContrast(rgb1, textColorRgb) < threshold) continue;

      for (let j = 0; j < activeColors.length; j++) {
        if (i === j) continue;

        const c2 = activeColors[j];
        
        // Skip if it's the same color (by hex value or ID) - normalize hex for comparison
        const hex1 = c1.hex.toUpperCase().trim();
        const hex2 = c2.hex.toUpperCase().trim();
        if (hex1 === hex2 || c1.id === c2.id) continue;
        
        const rgb2 = hexToRgb(c2.hex);
        
        // CRITICAL: Compare RGB values directly to catch identical colors
        // This catches cases where hex strings might differ but colors are identical
        if (rgb1.r === rgb2.r && rgb1.g === rgb2.g && rgb1.b === rgb2.b) {
          continue; // Skip identical colors
        }
        
        if (getContrast(rgb2, textColorRgb) < threshold) continue;

        // Filter by minimum contrast between the two combination colors
        const colorContrast = getContrast(rgb1, rgb2);
        // Identical colors have contrast of exactly 1.0, which should always be filtered out
        // Also filter out any contrast below the minimum threshold
        // Double-check: if contrast is <= 1.0, colors are identical or extremely similar
        if (colorContrast <= 1.0 || colorContrast < minBgContrast) {
          continue; // Skip combinations with insufficient contrast
        }

        const hsl1 = rgbToHsl(rgb1);
        const hsl2 = rgbToHsl(rgb2);

        const hueDist = Math.min(Math.abs(hsl1.h - hsl2.h), 360 - Math.abs(hsl1.h - hsl2.h));
        const satDist = Math.abs(hsl1.s - hsl2.s);
        const lumDist = Math.abs(hsl1.l - hsl2.l);

        if (hueDist >= minHueDistance && satDist >= minSatDistance && lumDist >= minLumDistance) {
          candidates.push({ c1, c2, hsl1, hsl2 });
        }
      }
    }

    if (minTotalDistance === 0) return candidates;

    const filtered: ComboWithMeta[] = [];
    for (const candidate of candidates) {
      let isDiverseEnough = true;
      for (const kept of filtered) {
        const comboDist = (getColorDistance(candidate.hsl1, kept.hsl1) + getColorDistance(candidate.hsl2, kept.hsl2)) / 2;
        if (comboDist < minTotalDistance) {
          isDiverseEnough = false;
          break;
        }
      }
      if (isDiverseEnough) filtered.push(candidate);
    }
    return filtered;
  }, [selectedIds, template, minHueDistance, minSatDistance, minLumDistance, minTotalDistance, minBgContrast, contrastLevel, textColorRgb, threshold, currentPalette]);

  const displayedCombinations = useMemo(() => {
    if (!isDiverse || baseCombinations.length <= 1) return baseCombinations;

    const pool = [...baseCombinations];
    const sorted: ComboWithMeta[] = [pool.shift()!];

    while (pool.length > 0) {
      let maxDist = -1;
      let bestIdx = 0;
      const last = sorted[sorted.length - 1];

      for (let i = 0; i < pool.length; i++) {
        const current = pool[i];
        const d1 = getColorDistance(last.hsl1, current.hsl1) + getColorDistance(last.hsl2, current.hsl2);
        const d2 = getColorDistance(last.hsl1, current.hsl2) + getColorDistance(last.hsl2, current.hsl1);
        const dist = Math.min(d1, d2);

        if (dist > maxDist) {
          maxDist = dist;
          bestIdx = i;
        }
      }
      sorted.push(pool.splice(bestIdx, 1)[0]);
    }
    return sorted;
  }, [baseCombinations, isDiverse]);

  return (
    <div className="flex flex-col h-screen overflow-hidden">
      <header className="bg-white border-b px-6 py-4 flex items-center justify-between shrink-0 shadow-sm z-10">
        <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
          <i className="fa-solid fa-palette text-indigo-600"></i>
          Hero Combinator
        </h1>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
            <button onClick={() => setViewMode('large')} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${viewMode === 'large' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}><i className="fa-solid fa-table-cells-large"></i> Preview</button>
            <button onClick={() => setViewMode('mini')} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${viewMode === 'mini' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}><i className="fa-solid fa-grip"></i> Mini</button>
          </div>
          <button 
            onClick={() => setIsDiverse(!isDiverse)} 
            className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold transition-all border ${isDiverse ? 'bg-indigo-50 border-indigo-200 text-indigo-600 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}
            title="Maximize visual difference between adjacent cards"
          >
            <i className={`fa-solid fa-shuffle ${isDiverse ? 'text-indigo-600' : 'text-slate-400'}`}></i> 
            Diverse Sort
          </button>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden">
        <aside className="w-96 bg-white border-r overflow-y-auto p-6 flex flex-col gap-6 shrink-0">
          <section>
            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Template</h3>
            <div className="flex bg-slate-100 p-1 rounded-lg">
              <button onClick={() => setTemplate(TemplateType.LIGHT)} className={`flex-1 px-4 py-2 rounded-md text-xs font-bold transition-all ${template === TemplateType.LIGHT ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}>LIGHT</button>
              <button onClick={() => setTemplate(TemplateType.DARK)} className={`flex-1 px-4 py-2 rounded-md text-xs font-bold transition-all ${template === TemplateType.DARK ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}>DARK</button>
            </div>
          </section>

          <section>
            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Text Contrast</h3>
            <div className="grid grid-cols-3 gap-2">
              {(['A', 'AA', 'AAA'] as ContrastLevel[]).map(level => (
                <button key={level} onClick={() => setContrastLevel(level)} className={`py-2 rounded-md border text-sm font-semibold transition-all ${contrastLevel === level ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white text-slate-600 hover:border-slate-300'}`}>{level}</button>
              ))}
            </div>
          </section>

          <section className="space-y-4">
            <div>
              <div className="flex justify-between mb-1.5">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Min BG Contrast</label>
                <span className="text-[10px] font-mono text-indigo-600 font-bold">{minBgContrast.toFixed(1)}:1</span>
              </div>
              <input type="range" min="1.0" max="5.0" step="0.1" value={minBgContrast} onChange={(e) => setMinBgContrast(parseFloat(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
            </div>

            {[{ label: 'Hue Distance', val: minHueDistance, set: setMinHueDistance, max: 180, unit: 'Â°' },
              { label: 'Sat Distance', val: minSatDistance, set: setMinSatDistance, max: 100, unit: '%' },
              { label: 'Lum Distance', val: minLumDistance, set: setMinLumDistance, max: 100, unit: '%' },
              { label: 'Diversity', val: minTotalDistance, set: setMinTotalDistance, max: 50, unit: '' }].map(ctrl => (
              <div key={ctrl.label}>
                <div className="flex justify-between mb-1.5"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{ctrl.label}</label><span className="text-[10px] font-mono text-indigo-600 font-bold">{ctrl.val}{ctrl.unit}</span></div>
                <input type="range" min="0" max={ctrl.max} step="1" value={ctrl.val} onChange={(e) => ctrl.set(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
              </div>
            ))}
          </section>

          <section className="flex flex-col flex-1 min-h-0 border-t pt-4">
            <div className="flex justify-between items-end mb-4">
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Palette Selection</h3>
              <div className="flex gap-2">
                <button onClick={deselectAll} className="text-[10px] text-slate-400 hover:text-slate-600">None</button>
                <button onClick={selectAll} className="text-[10px] text-slate-400 hover:text-slate-600">All Passing</button>
              </div>
            </div>
            
            {/* Palette Tabs */}
            <div className="flex bg-slate-100 p-1 rounded-lg mb-4 gap-1">
              <button 
                onClick={() => setPaletteType('tailwind')} 
                className={`flex-1 px-3 py-2 rounded-md text-xs font-bold transition-all ${paletteType === 'tailwind' ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}
              >
                Tailwind
              </button>
              <button 
                onClick={() => setPaletteType('tundra')} 
                className={`flex-1 px-3 py-2 rounded-md text-xs font-bold transition-all ${paletteType === 'tundra' ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}
              >
                Tundra
              </button>
              <button 
                onClick={() => setPaletteType('newyork')} 
                className={`flex-1 px-3 py-2 rounded-md text-xs font-bold transition-all ${paletteType === 'newyork' ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}
              >
                New York
              </button>
            </div>

            <div className="bg-slate-50 border rounded-xl overflow-hidden flex flex-col flex-1 min-h-0">
              {paletteType === 'tundra' ? (
                // Tundra palette - simple grid of 14 colors
                <div className="overflow-y-auto flex-1 p-4">
                  <div className="grid grid-cols-7 gap-2">
                    {TUNDRA_COLORS.map(color => {
                      const passes = checkContrast(color.hex);
                      return (
                        <button
                          key={color.id}
                          disabled={!passes}
                          onClick={() => toggleId(color.id)}
                          className={`relative aspect-square rounded-lg transition-all border-2 ${
                            passes 
                              ? selectedIds.has(color.id)
                                ? 'border-indigo-600 ring-2 ring-indigo-200' 
                                : 'border-slate-200 hover:border-slate-300 cursor-pointer'
                              : 'opacity-10 grayscale pointer-events-none border-slate-100'
                          }`}
                          style={{ backgroundColor: color.hex }}
                          title={color.name}
                        >
                          {passes && selectedIds.has(color.id) && (
                            <i className={`fa-solid fa-check text-[10px] drop-shadow-sm absolute top-1 right-1 ${template === TemplateType.LIGHT ? 'text-black' : 'text-white'}`}></i>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>
              ) : paletteType === 'newyork' ? (
                // New York palette - grid of 24 colors (8 columns x 3 rows)
                <div className="overflow-y-auto flex-1 p-4">
                  <div className="grid grid-cols-8 gap-2">
                    {NEWYORK_COLORS.map(color => {
                      const passes = checkContrast(color.hex);
                      return (
                        <button
                          key={color.id}
                          disabled={!passes}
                          onClick={() => toggleId(color.id)}
                          className={`relative aspect-square rounded-lg transition-all border-2 ${
                            passes 
                              ? selectedIds.has(color.id)
                                ? 'border-indigo-600 ring-2 ring-indigo-200' 
                                : 'border-slate-200 hover:border-slate-300 cursor-pointer'
                              : 'opacity-10 grayscale pointer-events-none border-slate-100'
                          }`}
                          style={{ backgroundColor: color.hex }}
                          title={color.name}
                        >
                          {passes && selectedIds.has(color.id) && (
                            <i className={`fa-solid fa-check text-[10px] drop-shadow-sm absolute top-1 right-1 ${template === TemplateType.LIGHT ? 'text-black' : 'text-white'}`}></i>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>
              ) : (
                // Tailwind palette - original grid with shades
                <>
                  <div className="grid grid-cols-[80px_repeat(11,minmax(0,1fr))] bg-slate-100 border-b text-[9px] font-bold text-slate-500">
                    <div className="px-2 py-1.5 border-r uppercase flex items-center">Color</div>
                    {SHADES.map(s => (
                      <button 
                        key={s} 
                        onClick={() => toggleShadeGroup(s)}
                        className="h-8 flex flex-col items-center justify-center hover:bg-slate-200 transition-colors border-l first:border-l-0 border-slate-200"
                        title={`Toggle all ${s} shades`}
                      >
                        <div className="text-[8px] opacity-40">
                          <i className="fa-solid fa-chevron-down"></i>
                        </div>
                      </button>
                    ))}
                  </div>
                  <div className="overflow-y-auto flex-1">
                    {COLOR_NAMES.map(name => {
                       const shades = SHADES.map(s => ({ hex: TAILWIND_COLORS[name][s], id: `${name}-${s}`, passes: checkContrast(TAILWIND_COLORS[name][s]) }));
                       return (
                         <div key={name} className="grid grid-cols-[80px_repeat(11,minmax(0,1fr))] border-b border-slate-100 last:border-0 hover:bg-white group/row">
                            <button onClick={() => toggleColorGroup(name)} className="px-2 py-1.5 text-[9px] font-bold uppercase text-left truncate border-r border-slate-100 text-slate-400 group-hover/row:text-slate-600">{name}</button>
                            {shades.map(s => (
                              <button key={s.id} disabled={!s.passes} onClick={() => toggleId(s.id)} className={`relative h-8 transition-all flex items-center justify-center ${s.passes ? 'cursor-pointer' : 'opacity-10 grayscale pointer-events-none'}`} style={{ backgroundColor: s.hex }}>
                                {s.passes && selectedIds.has(s.id) && (
                                  <i className={`fa-solid fa-check text-[8px] drop-shadow-sm ${template === TemplateType.LIGHT ? 'text-black' : 'text-white'}`}></i>
                                )}
                              </button>
                            ))}
                         </div>
                       );
                    })}
                  </div>
                </>
              )}
            </div>
          </section>
        </aside>

        <main className="flex-1 bg-slate-50 overflow-y-auto p-8">
          <div className="max-w-6xl mx-auto">
            <div className="flex items-center justify-between mb-8">
              <div><h2 className="text-2xl font-bold text-slate-800">Visual Results</h2><p className="text-slate-500 text-sm mt-1">Showing <span className="font-bold text-indigo-600">{displayedCombinations.length}</span> results.</p></div>
            </div>

            {displayedCombinations.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-32 text-center bg-white rounded-3xl border border-dashed border-slate-300">
                <i className="fa-solid fa-circle-nodes text-slate-200 text-4xl mb-4"></i>
                <h3 className="text-lg font-medium text-slate-600">No results found</h3>
                <p className="text-slate-400 max-w-xs mx-auto mt-2">Try selecting more colors from the palette or loosening the distance and contrast filters.</p>
              </div>
            ) : viewMode === 'large' ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                {displayedCombinations.map((combo, idx) => (
                  <div key={`${combo.c1.id}-${combo.c2.id}-${idx}`} className="group bg-white rounded-[6px] overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-500 border border-slate-200 flex flex-col cursor-pointer hover:-translate-y-1">
                    <div className="relative aspect-[100/142] w-full bg-slate-100 flex items-center justify-center overflow-hidden">
                       <HeroPreview color1={combo.c1.hex} color2={combo.c2.hex} textColor={textColorHex} template={template} />
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="flex flex-wrap gap-2">
                {displayedCombinations.map((combo, idx) => (
                  <div key={`${combo.c1.id}-${combo.c2.id}-${idx}`} className="group w-28 h-28 relative rounded-[6px] overflow-hidden shadow-sm hover:scale-110 transition-transform cursor-pointer border border-slate-200">
                    <HeroPreview 
                      color1={combo.c1.hex} 
                      color2={combo.c2.hex} 
                      textColor={textColorHex}
                      template={template}
                    />
                  </div>
                ))}
              </div>
            )}
          </div>
        </main>
      </div>
    </div>
  );
}
